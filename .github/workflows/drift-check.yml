name: Helm Drift Detection

on:
  pull_request:
    branches: [ main, master ]
    paths:
      - 'Helm-Drift-Detector/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write

env:
  WORKDIR: Helm-Drift-Detector/Helm-Drift-Detection/Helm-Detection

jobs:
  detect-drift:
    name: Detect Drift in HPA/Service Config 
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
      
    - name: Authenticate to GCP (uses your JSON secret)
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}
        
    - name: Get GKE Credentials 
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: cluster-1
        location: us-central1
        project_id: exchange-sandbox-2f1f
        
    - name: Install Helm + yq
      run: |
        # Install Helm
        curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

        # Install yq (curl method)
        YQ_VERSION=v4.44.3
        curl -L https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 -o /usr/local/bin/yq

        # Make yq executable
        sudo chmod +x /usr/local/bin/yq

        # Check the installed versions
        helm version && yq --version
        
    - name: Debug & verify files
      run: |
        set -euxo pipefail
        echo "Workspace: $GITHUB_WORKSPACE"
        ls -la 
        echo "---- Listing $WORKDIR ----"
        ls -la "$WORKDIR"
        echo "--- find detect-drift & desired.yaml ----"
        find "$WORKDIR" -maxdepth 3 -type f \( -name "detect-drift.sh" -o -name "desired.yaml" \) -print 
        test -f "$WORKDIR/scripts/detect-drift.sh"
        test -f "$WORKDIR/desired.yaml" || (echo "desired.yaml missing in SWORKDIR" && exit 2) 
        chmod +x "$WORKDIR/scripts/detect-drift.sh"
        
    - name: Run Drift Detection Script 
      working-directory: ${{ env.WORKDIR }} 
      run: |
        set -euxo pipefail 
        bash ./scripts/detect-drift.sh ./desired.yaml | tee drift.log
        
    - name: Upload Drift Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: drift-report
        path: ${{ github.workspace }}/Helm-Drift-Detector/Helm-Drift-Detector/Helm-Drift-Detection/Helm-Detection/reports/drift_report_history.csv

    - name: Fail PR if Drift Detected
      if: failure()
      run: | 
        echo " DRIFT DETECTED. Failing build."
        exit 1
